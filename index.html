<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAAC V7.1 - Gram√°tica Pro</title>
    <style>
        :root { --barra-color: #512DA8; --bg-color: #fafafa; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* PANTALLA DE INICIO */
        #pantalla-inicio {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #673AB7 0%, #3F51B5 100%);
            z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 40px; color: white;
            transition: transform 0.4s ease-in-out;
        }
        .titulo-inicio { font-size: 28px; font-weight: bold; text-align: center; margin: 0 20px; }
        
        .contenedor-botones-inicio { display: flex; gap: 30px; }
        .btn-genero {
            background: white; border: none; padding: 25px; border-radius: 25px;
            display: flex; flex-direction: column; align-items: center; width: 140px;
            cursor: pointer; box-shadow: 0 15px 30px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-genero:active { transform: scale(0.9); }
        .btn-genero span { font-size: 70px; margin-bottom: 10px; }
        .btn-genero strong { font-size: 22px; color: #444; }

        /* APP PRINCIPAL */
        #app-principal { display: none; flex-direction: column; height: 100%; }

        #frase-container {
            background-color: var(--barra-color); padding: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
            display: flex; flex-direction: column; gap: 12px;
        }

        #visualizador-frase {
            min-height: 80px; background-color: white; border-radius: 15px;
            border: 2px solid #D1C4E9; display: flex; align-items: center;
            padding: 5px 10px; gap: 8px; overflow-x: auto;
        }

        .picto-en-frase {
            background: #EDE7F6; border-radius: 10px; padding: 6px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid #D1C4E9; min-width: auto;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .picto-en-frase span { font-size: 24px; }
        .picto-en-frase small { font-size: 14px; font-weight: 700; color: #333; margin-top: 2px; white-space: nowrap; }

        .controles { display: flex; gap: 15px; }
        button.accion {
            flex: 1; padding: 15px; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer; text-transform: uppercase;
            color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); letter-spacing: 1px;
        }
        button.accion:active { transform: scale(0.96); }
        #btn-hablar { background-color: #00C853; }
        #btn-borrar { background-color: #FF1744; }

        #tablero {
            flex: 1; padding: 15px; overflow-y: auto; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            grid-auto-rows: 110px; gap: 12px; align-content: start;
        }

        .tarjeta-picto {
            background: white; border-radius: 16px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border-bottom: 5px solid #E0E0E0; position: relative;
        }
        .tarjeta-picto:active { border-bottom: 0px solid transparent; transform: translateY(5px); background-color: #f5f5f5; }
        .tarjeta-picto .emoji { font-size: 40px; margin-bottom: 5px; }
        .tarjeta-picto .label { font-size: 13px; font-weight: bold; text-align: center; color: #444; line-height: 1.1; }

        .cat-persona { border-top: 5px solid #FFD600; }
        .cat-accion { border-top: 5px solid #2962FF; }
        .cat-objeto { border-top: 5px solid #00C853; }
        .cat-emocion { border-top: 5px solid #AA00FF; }
    </style>
</head>
<body>

    <div id="pantalla-inicio">
        <div class="titulo-inicio">¬°Hola! üëã<br>¬øQui√©n va a hablar hoy?</div>
        <div class="contenedor-botones-inicio">
            <button class="btn-genero" onclick="iniciarApp('nino')"><span>üë¶</span><strong>Ni√±o</strong></button>
            <button class="btn-genero" onclick="iniciarApp('nina')"><span>üëß</span><strong>Ni√±a</strong></button>
        </div>
        <div id="info-debug" style="font-size: 10px; opacity: 0.7; position: absolute; bottom: 10px;"></div>
    </div>

    <div id="app-principal">
        <div id="frase-container">
            <div id="visualizador-frase"></div>
            <div class="controles">
                <button id="btn-borrar" class="accion" onclick="borrarFrase()">Borrar</button>
                <button id="btn-hablar" class="accion" onclick="reproducirFrase()">üó£Ô∏è Hablar</button>
            </div>
        </div>
        <div id="tablero"></div>
    </div>

    <script>
        const pictogramas = [
            { id: 'yo', texto: "Yo", hablar: "Yo", emoji: "üôã‚Äç‚ôÇÔ∏è", tipo: "persona" }, 
            { texto: "T√∫", hablar: "T√∫", emoji: "üëâ", tipo: "persona" },
            { texto: "Mam√°", hablar: "Mam√°", emoji: "üë©", tipo: "persona" },
            { texto: "Pap√°", hablar: "Pap√°", emoji: "üë®", tipo: "persona" },

            { texto: "Quiero", hablar: "quiero", emoji: "ü§≤", tipo: "accion" },
            { texto: "Ir", hablar: "ir", emoji: "üö∂", tipo: "accion" },
            { texto: "Comer", hablar: "comer", emoji: "üçé", tipo: "accion" },
            { texto: "Beber", hablar: "beber", emoji: "ü•õ", tipo: "accion" },
            { texto: "Jugar", hablar: "jugar", emoji: "‚öΩ", tipo: "accion" },
            { texto: "Dormir", hablar: "dormir", emoji: "üò¥", tipo: "accion" },
            { texto: "Ver", hablar: "ver", emoji: "üëÄ", tipo: "accion" },

            { texto: "Ba√±o", hablar: "al ba√±o", emoji: "üöΩ", tipo: "objeto" },
            { texto: "Parque", hablar: "al parque", emoji: "üõù", tipo: "objeto" },
            { texto: "Casa", hablar: "a casa", emoji: "üè†", tipo: "objeto" },
            { texto: "Colegio", hablar: "al colegio", emoji: "üè´", tipo: "objeto" },
            { texto: "Tablet", hablar: "la tablet", emoji: "üì±", tipo: "objeto" },
            { texto: "Agua", hablar: "agua", emoji: "üíß", tipo: "objeto" },
            { texto: "Comida", hablar: "comida", emoji: "üçî", tipo: "objeto" },
            
            { texto: "Feliz", hablar: "estoy feliz", emoji: "üòä", tipo: "emocion" },
            { texto: "Triste", hablar: "estoy triste", emoji: "üò¢", tipo: "emocion" },
            { id: 'enojado', texto: "Enojado", hablar: "estoy enojado", emoji: "üò°", tipo: "emocion" },
            { texto: "S√≠", hablar: "s√≠", emoji: "‚úÖ", tipo: "emocion" },
            { texto: "No", hablar: "no", emoji: "‚ùå", tipo: "emocion" }
        ];

        let fraseActual = []; 
        const synth = window.speechSynthesis;
        let vozSeleccionada = null;
        let generoSeleccionado = 'nino';
        let pitchGlobal = 1.0;

        function iniciarApp(genero) {
            generoSeleccionado = genero;
            document.getElementById('pantalla-inicio').style.transform = 'translateY(-100%)';
            
            if (genero === 'nina') {
                pitchGlobal = 1.3; 
                const pictoYo = pictogramas.find(p => p.id === 'yo');
                if (pictoYo) pictoYo.emoji = 'üôã‚Äç‚ôÄÔ∏è';
                const pictoEnojado = pictogramas.find(p => p.id === 'enojado');
                if (pictoEnojado) {
                    pictoEnojado.texto = 'Enojada';
                    pictoEnojado.hablar = 'estoy enojada';
                    pictoEnojado.emoji = 'üôç‚Äç‚ôÄÔ∏è';
                }
            } else {
                pitchGlobal = 0.9;
            }

            setTimeout(() => {
                document.getElementById('app-principal').style.display = 'flex';
                cargarVoces();
                renderizarTablero();
            }, 300);
        }

        function cargarVoces() {
            const voces = synth.getVoices();
            if (voces.length === 0) return;
            let vozEncontrada = voces.find(v => v.name.includes('Google') && v.lang.includes('es'));
            if (!vozEncontrada) vozEncontrada = voces.find(v => v.lang.includes('es'));
            if (vozEncontrada) {
                vozSeleccionada = vozEncontrada;
                document.getElementById('info-debug').innerText = "Voz: " + vozSeleccionada.name;
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = cargarVoces;
        }

        function renderizarTablero() {
            const tablero = document.getElementById('tablero');
            tablero.innerHTML = ''; 
            pictogramas.forEach(picto => {
                const btn = document.createElement('div');
                btn.className = `tarjeta-picto cat-${picto.tipo}`;
                btn.innerHTML = `<span class="emoji">${picto.emoji}</span><span class="label">${picto.texto}</span>`;
                btn.onclick = () => agregarAFrase(picto);
                btn.onmousedown = () => btn.style.transform = "scale(0.95)";
                btn.onmouseup = () => btn.style.transform = "scale(1)";
                tablero.appendChild(btn);
            });
        }

        function agregarAFrase(picto) {
            fraseActual.push(picto);
            actualizarVisualizador();
        }

        function actualizarVisualizador() {
            const visualizador = document.getElementById('visualizador-frase');
            visualizador.innerHTML = ''; 

            fraseActual.forEach((picto, index) => {
                const elemento = document.createElement('div');
                elemento.className = 'picto-en-frase';
                
                // L√ìGICA VISUAL: Si es "Ir" y viene una acci√≥n, mostramos una peque√±a flecha o indicio
                let conectorVisual = "";
                // No mostramos la 'a' visualmente para no saturar al ni√±o, pero se escuchar√°.
                
                const textoMostrar = picto.hablar ? picto.hablar : picto.texto;
                elemento.innerHTML = `<span>${picto.emoji}</span><small>${textoMostrar}</small>`;
                visualizador.appendChild(elemento);
            });
            visualizador.scrollTop = visualizador.scrollHeight;
            visualizador.scrollLeft = visualizador.scrollWidth;
        }

        function borrarFrase() {
            fraseActual = [];
            actualizarVisualizador();
        }

        // --- MOTOR DE GRAM√ÅTICA INTELIGENTE ---
        function reproducirFrase() {
            if (fraseActual.length === 0) return;

            let fraseParaLeer = [];

            // Recorremos la frase para inyectar conectores
            for (let i = 0; i < fraseActual.length; i++) {
                const actual = fraseActual[i];
                const siguiente = fraseActual[i + 1]; // Puede ser undefined si es el √∫ltimo

                // 1. Agregamos la palabra actual
                fraseParaLeer.push(actual.hablar || actual.texto);

                // 2. REGLA MAESTRA: Si actual es "Ir" y siguiente es "Acci√≥n" -> Agregar "a"
                if (actual.texto === 'Ir' && siguiente && siguiente.tipo === 'accion') {
                    fraseParaLeer.push("a");
                }
            }

            const textoFinal = fraseParaLeer.join(" ");

            // Debug en consola para que veas qu√© est√° armando
            console.log("Hablando: " + textoFinal);

            synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(textoFinal);
            if (vozSeleccionada) utterThis.voice = vozSeleccionada;
            utterThis.lang = 'es-ES';
            utterThis.pitch = pitchGlobal; 
            utterThis.rate = 0.9; 

            synth.speak(utterThis);
        }
    </script>
</body>
</html>
